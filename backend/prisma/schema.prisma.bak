generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

model Role {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermissions?
  users           User[]
}

model Menu {
  id            Int              @id @default(autoincrement())
  title         String           @unique
  icon          String?
  url           String?
  isCollapsible Boolean          @default(false)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  roleMenus     RoleMenuAccess[]
  subMenus      SubMenu[]
}

model SubMenu {
  id           Int                 @id @default(autoincrement())
  title        String
  url          String
  menuId       Int
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  roleSubMenus RoleSubMenuAccess[]
  menu         Menu                @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@index([menuId], map: "SubMenu_menuId_fkey")
}

model RolePermissions {
  id        Int              @id @default(autoincrement())
  roleId    Int              @unique
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  menus     RoleMenuAccess[]
  role      Role             @relation(fields: [roleId], references: [id])
}

model RoleMenuAccess {
  id                Int                 @id @default(autoincrement())
  rolePermissionsId Int
  menuId            Int
  canView           Boolean             @default(true)
  canAdd            Boolean             @default(false)
  canEdit           Boolean             @default(false)
  canDelete         Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  menu              Menu                @relation(fields: [menuId], references: [id])
  rolePermissions   RolePermissions     @relation(fields: [rolePermissionsId], references: [id])
  subMenus          RoleSubMenuAccess[]

  @@unique([rolePermissionsId, menuId])
  @@index([menuId], map: "RoleMenuAccess_menuId_fkey")
}

model RoleSubMenuAccess {
  id               Int            @id @default(autoincrement())
  roleMenuAccessId Int
  subMenuId        Int
  canView          Boolean        @default(true)
  canAdd           Boolean        @default(false)
  canEdit          Boolean        @default(false)
  canDelete        Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  roleMenuAccess   RoleMenuAccess @relation(fields: [roleMenuAccessId], references: [id])
  subMenu          SubMenu        @relation(fields: [subMenuId], references: [id])

  @@unique([roleMenuAccessId, subMenuId])
  @@index([subMenuId], map: "RoleSubMenuAccess_subMenuId_fkey")
}

model User {
  id                 Int                  @id @default(autoincrement())
  fullName           String
  email              String               @unique
  phone              String?
  password           String
  status             String               @default("active")
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  roleId             Int
  gender             String?
  photo              String?
  transfersPerformed DepartmentTransfer[] @relation("TransfersPerformed")
  employee           Employee?
  role               Role                 @relation(fields: [roleId], references: [id])

  // ðŸ‘‡ ADD THESE
  idsCreated IdGenerate[] @relation("IdCreatedBy")
  idsPrinted IdGenerate[] @relation("IdPrintedBy")
  auditLogs  AuditLog[]

  @@index([roleId], map: "User_roleId_fkey")
}

model Employee {
  id           Int                  @id @default(autoincrement())
  address      String?
  dob          DateTime?
  status       String               @default("active")
  departmentId Int
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  title        String?
  userId       Int                  @unique
  transfers    DepartmentTransfer[]
  department   Department           @relation(fields: [departmentId], references: [id])
  user         User                 @relation(fields: [userId], references: [id])
  idGenerates  IdGenerate[]

  @@index([departmentId], map: "Employee_departmentId_fkey")
}

model Department {
  id             Int                  @id @default(autoincrement())
  departmentName String               @unique
  description    String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  transfersFrom  DepartmentTransfer[] @relation("FromDepartment")
  transfersTo    DepartmentTransfer[] @relation("ToDepartment")
  employees      Employee[]
  idGenerates    IdGenerate[]
}

model DepartmentTransfer {
  id               Int        @id @default(autoincrement())
  employeeId       Int
  fromDepartmentId Int
  toDepartmentId   Int
  transferDate     DateTime
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  authorizedById   Int?
  reason           String?
  authorizedBy     User?      @relation("TransfersPerformed", fields: [authorizedById], references: [id])
  employee         Employee   @relation(fields: [employeeId], references: [id])
  fromDepartment   Department @relation("FromDepartment", fields: [fromDepartmentId], references: [id])
  toDepartment     Department @relation("ToDepartment", fields: [toDepartmentId], references: [id])

  @@index([authorizedById], map: "DepartmentTransfer_authorizedById_fkey")
  @@index([employeeId], map: "DepartmentTransfer_employeeId_fkey")
  @@index([fromDepartmentId], map: "DepartmentTransfer_fromDepartmentId_fkey")
  @@index([toDepartmentId], map: "DepartmentTransfer_toDepartmentId_fkey")
}

model IdCardTemplate {
  id              Int      @id @default(autoincrement())
  name            String   @unique
  description     String?
  width           Int
  height          Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  backBackground  String?
  frontBackground String
  status          String   @default("active")
  layout          Json?

  // ðŸ‘‡ ADD THIS
  idGenerates IdGenerate[]
}

enum IdGenerateStatus {
  created
  ready_to_print
  printed
  lost
  replaced
  expired

}

model IdGenerate {
  id Int @id @default(autoincrement())

  employeeId   Int
  templateId   Int
  departmentId Int?
  createdById  Int
  printedById  Int?

  employee  Employee       @relation(fields: [employeeId], references: [id])
  template  IdCardTemplate @relation(fields: [templateId], references: [id])
  department Department?   @relation(fields: [departmentId], references: [id])
  createdBy User           @relation("IdCreatedBy", fields: [createdById], references: [id])
  printedBy User?          @relation("IdPrintedBy", fields: [printedById], references: [id])

  qrCode String @unique

  status IdGenerateStatus @default(created)

  issueDate  DateTime?
  expiryDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("id_generate")
}


model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int
  action     String
  tableName  String
  recordId   Int?       // record id ee la bedelay, optional
  oldData    Json?      // xogta hore, optional
  newData    Json?      // xogta cusub, optional
  ipAddress  String?    // IP address-ka qofka sameeyay action
  createdAt  DateTime   @default(now())

  user       User       @relation(fields: [userId], references: [id])

  @@index([userId], map: "AuditLog_userId_fkey")
}
